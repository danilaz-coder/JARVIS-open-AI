import os
import logging
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
from openai import OpenAI
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(name)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI
openai_api_key = os.getenv("OPENAI_API_KEY")
if not openai_api_key:
    raise ValueError("OPENAI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!")

client = OpenAI(api_key=openai_api_key)

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –î–∂–∞—Ä–≤–∏—Å–∞-—Ç—Ä–µ–Ω–µ—Ä–∞
SYSTEM_PROMPT = """–¢—ã ‚Äî –î–∂–∞—Ä–≤–∏—Å, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π AI-—Ç—Ä–µ–Ω–µ—Ä –∏ –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥. –¢–≤–æ–∏ –∑–Ω–∞–Ω–∏—è:
1. –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: —Å–∏–ª–æ–≤—ã–µ, –∫–∞—Ä–¥–∏–æ, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ, —Ä–∞—Å—Ç—è–∂–∫–∞. –°–æ—Å—Ç–∞–≤–ª—è–µ—à—å –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–æ–¥ —Ü–µ–ª–∏ (–ø–æ—Ö—É–¥–µ–Ω–∏–µ, –º–∞—Å—Å–∞, —Ç–æ–Ω—É—Å).
2. –ü–∏—Ç–∞–Ω–∏–µ: –ë–ñ–£, –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å, —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ, –¥–∏–µ—Ç—ã, —Ä–µ–∂–∏–º –ø–∏—Ç–∞–Ω–∏—è.
3. –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è: –º–æ—Ç–∏–≤–∞—Ü–∏—è, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, –º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞, –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–æ.
4. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: —Å–æ–Ω, —Å—Ç—Ä–µ—Å—Å, –∞–∫—Ç–∏–≤–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ.

–û—Ç–≤–µ—á–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏. –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å ‚Äî —á–µ—Å—Ç–Ω–æ –≥–æ–≤–æ—Ä–∏, –Ω–æ –ø—Ä–µ–¥–ª–∞–≥–∞–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É."""

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    welcome_text = """üèãÔ∏è‚Äç‚ôÇÔ∏è *–ü—Ä–∏–≤–µ—Ç! –Ø –î–∂–∞—Ä–≤–∏—Å ‚Äî —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π AI-—Ç—Ä–µ–Ω–µ—Ä!*

–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ —Å:
‚Ä¢ –ü—Ä–æ–≥—Ä–∞–º–º–∞–º–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
‚Ä¢ –ü–∏—Ç–∞–Ω–∏–µ–º –∏ –ë–ñ–£
‚Ä¢ –°–ø–æ—Ä—Ç–∏–≤–Ω–æ–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏–µ–π
‚Ä¢ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º

–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å, –Ω–∞–ø—Ä–∏–º–µ—Ä:
‚Ä¢ "–ö–∞–∫ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –Ω–∞ –º–∞—Å—Å—É?"
‚Ä¢ "–ß—Ç–æ –µ—Å—Ç—å –ø–µ—Ä–µ–¥ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–æ–π?"
‚Ä¢ "–ö–∞–∫ –º–æ—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–µ–±—è –∑–∞–Ω–∏–º–∞—Ç—å—Å—è?"
‚Ä¢ "–°–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ –±–µ–ª–∫–∞ –≤ –¥–µ–Ω—å?"

–ü–∏—à–∏ ‚Äî –ø–æ–º–æ–≥—É! üí™"""
    await update.message.reply_text(welcome_text, parse_mode='Markdown')

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    user_message = update.message.text
    
    try:
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –±–æ—Ç "–ø–µ—á–∞—Ç–∞–µ—Ç"
        await update.message.chat.send_action(action="typing")
        
        # –ó–∞–ø—Ä–æ—Å –∫ OpenAI
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT},
                {"role": "user", "content": user_message}
            ],
            temperature=0.7,
            max_tokens=1000
        )
        
        answer = response.choices[0].message.content
        await update.message.reply_text(answer, parse_mode='Markdown')
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞: {e}")
        await update.message.reply_text("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å.")

async def workout_plan(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü—Ä–∏–º–µ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–ª–∞–Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫"""
    plan = """*üí™ –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–∞ 3 –¥–Ω—è:*

*–î–µ–Ω—å 1: –ì—Ä—É–¥—å + –¢—Ä–∏—Ü–µ–ø—Å*
‚Ä¢ –ñ–∏–º —à—Ç–∞–Ω–≥–∏ –ª–µ–∂–∞ 4x8-12
‚Ä¢ –†–∞–∑–≤–æ–¥–∫–∞ –≥–∞–Ω—Ç–µ–ª–µ–π 3x12-15
‚Ä¢ –û—Ç–∂–∏–º–∞–Ω–∏—è –Ω–∞ –±—Ä—É—Å—å—è—Ö 3x10-15
‚Ä¢ –§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º 3x12-15

*–î–µ–Ω—å 2: –°–ø–∏–Ω–∞ + –ë–∏—Ü–µ–ø—Å*
‚Ä¢ –ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è 4x–º–∞–∫—Å
‚Ä¢ –¢—è–≥–∞ —à—Ç–∞–Ω–≥–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ 4x8-12
‚Ä¢ –¢—è–≥–∞ –≥–∞–Ω—Ç–µ–ª–∏ –æ–¥–Ω–æ–π —Ä—É–∫–æ–π 3x10-12
‚Ä¢ –ü–æ–¥—ä–µ–º —à—Ç–∞–Ω–≥–∏ –Ω–∞ –±–∏—Ü–µ–ø—Å 3x10-12

*–î–µ–Ω—å 3: –ù–æ–≥–∏ + –ü–ª–µ—á–∏*
‚Ä¢ –ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è 4x8-12
‚Ä¢ –ñ–∏–º –Ω–æ–≥–∞–º–∏ 3x10-15
‚Ä¢ –ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π —Å–∏–¥—è 4x10-12
‚Ä¢ –ú–∞—Ö–∏ –≤ —Å—Ç–æ—Ä–æ–Ω—ã 3x15-20

*–û—Ç–¥—ã—Ö –º–µ–∂–¥—É –ø–æ–¥—Ö–æ–¥–∞–º–∏:* 60-90 —Å–µ–∫
*–ß–∞—Å—Ç–æ—Ç–∞:* 3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é"""
    
    await update.message.reply_text(plan, parse_mode='Markdown')

def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
    bot_token = os.getenv("TELEGRAM_BOT_TOKEN")
    if not bot_token:
        raise ValueError("TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    application = Application.builder().token(bot_token).build()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    application.add_handler(CommandHandler("start", start))

application.add_handler(CommandHandler("workout", workout_plan))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    print("ü§ñ –î–∂–∞—Ä–≤–∏—Å-—Ç—Ä–µ–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω...")
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if name == 'main':
    main()
